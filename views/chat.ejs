<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <%- include('partials/pwa') %>
  <title>家庭AI助手 - 我們的家庭空間</title>
  <style>
    .chat-container {
      max-width: 800px;
      margin: 0 auto;
      height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      background: #f8f9fa;
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 0.375rem;
    }
    .user-message {
      background: #007bff;
      color: white;
      margin-left: 20%;
    }
    .bot-message {
      background: white;
      border: 1px solid #dee2e6;
      margin-right: 20%;
    }
    .typing-indicator {
      display: none;
      padding: 0.75rem;
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>家庭AI助手</h2>
      <a href="/dashboard" class="btn btn-secondary">返回儀表板</a>
    </div>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
          <strong>AI助手：</strong>您好！我是您的家庭AI助手，有什麼可以幫您的嗎？
        </div>
      </div>

      <div class="typing-indicator" id="typingIndicator">
        AI正在思考...
      </div>

      <div class="input-group">
        <input type="text" class="form-control" id="messageInput" 
               placeholder="輸入您的問題..." autocomplete="off">
        <button class="btn btn-primary" id="sendButton">發送</button>
      </div>
    </div>
  </div>

  <script>
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');

    let currentConversationId = null;

    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
      messageDiv.innerHTML = `<strong>${isUser ? '您：' : 'AI助手：'}</strong>${content}`;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping() {
      typingIndicator.style.display = 'block';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      typingIndicator.style.display = 'none';
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // 添加用戶消息
      addMessage(message, true);
      messageInput.value = '';
      sendButton.disabled = true;

      // 顯示輸入指示
      showTyping();

      try {
        const response = await fetch('/api/chat/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            conversation_id: currentConversationId
          })
        });

        const data = await response.json();

        if (data.success) {
          addMessage(data.response);
          currentConversationId = data.conversation_id;
        } else {
          addMessage('抱歉，AI助手暫時無法回應。請稍後再試。');
        }
      } catch (error) {
        console.error('發送消息錯誤:', error);
        addMessage('網絡錯誤，請檢查連接後重試。');
      } finally {
        hideTyping();
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    // 事件監聽
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // 初始焦點
    messageInput.focus();
  </script>
</body>
</html>