<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <%- include('partials/pwa') %>
  <!-- 引入 moment.js 和 moment-timezone -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
  <title>檔案管理</title>
</head>
<body>
  <div class="container mt-5 filemanager">
    <h2 class="text-center mb-5">檔案管理</h2>
    
    <!-- 檔案上傳區域 -->
    <div class="card p-4 mb-4">
      <h3 class="text-info">上傳檔案</h3>
      <form id="fileUploadForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="customName" class="form-label text-info">檔案名稱</label>
          <input type="text" id="customName" name="customName" class="form-control" placeholder="輸入自訂檔案名稱" required>
        </div>
        <div class="mb-3">
          <label for="description" class="form-label text-info">檔案描述</label>
          <textarea id="description" name="description" class="form-control" placeholder="輸入檔案描述（可選）" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label for="fileInput" class="form-label text-info">選擇檔案</label>
          <input type="file" id="fileInput" name="file" class="form-control file-input" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">上傳</button>
      </form>
    </div>

    <!-- 檔案列表區域 -->
    <div class="mt-4">
      <h3 class="text-info">檔案列表</h3>
      <ul id="fileList" class="list-group"></ul>
    </div>

    <!-- 編輯模態框 -->
    <div class="modal fade" id="editFileModal" tabindex="-1" aria-labelledby="editFileModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editFileModalLabel">編輯檔案資訊</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
          </div>
          <div class="modal-body">
            <form id="editFileForm">
              <input type="hidden" id="editFilename">
              <div class="mb-3">
                <label for="editCustomName" class="form-label text-info">檔案名稱</label>
                <input type="text" id="editCustomName" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="editDescription" class="form-label text-info">檔案描述</label>
                <textarea id="editDescription" class="form-control" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="saveFileChanges()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <a href="/dashboard" class="btn btn-secondary">返回儀表板</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 載入檔案列表
    function loadFiles() {
      fetch('/filemanager/files')
        .then(response => response.json())
        .then(data => {
          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';
          if (!Array.isArray(data) || data.length === 0) {
            const li = document.createElement('li');
            li.className = 'list-group-item text-center';
            li.textContent = '暫無檔案';
            fileList.appendChild(li);
            return;
          }
          data.forEach(file => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            const isImage = file.mime_type === 'image/jpeg' || file.mime_type === 'image/png';
            li.innerHTML = `
              <div>
                ${isImage ? `<img src="/uploads/${file.filename}" alt="${file.custom_name || file.original_name}" class="thumbnail">` : ''}
                <a href="/uploads/${file.filename}" target="_blank" class="text-info">${file.custom_name || file.original_name}</a>
                <small class="d-block text-muted">描述: ${file.description || '無'}</small>
                <small class="d-block text-muted">上傳時間: ${formatDisplayDateTime(file.uploaded_at)}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-warning me-2" onclick="openEditModal('${file.filename}', '${file.custom_name}', '${file.description || ''}')">編輯</button>
                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.filename}')">刪除</button>
              </div>
            `;
            fileList.appendChild(li);
          });
        })
        .catch(err => {
          console.error('載入檔案列表失敗:', err);
          alert('載入檔案列表失敗，請稍後重試');
        });
    }

    // 格式化顯示日期時間
    function formatDisplayDateTime(datetime) {
      return moment(datetime).tz('Asia/Hong_Kong').format('YYYY-MM-DD HH:mm');
    }

    // 開啟編輯模態框
    function openEditModal(filename, customName, description) {
      document.getElementById('editFilename').value = filename;
      document.getElementById('editCustomName').value = customName;
      document.getElementById('editDescription').value = description;
      const modal = new bootstrap.Modal(document.getElementById('editFileModal'));
      modal.show();
    }

    // 儲存檔案資訊變更
    function saveFileChanges() {
      const filename = document.getElementById('editFilename').value;
      const customName = document.getElementById('editCustomName').value.trim();
      const description = document.getElementById('editDescription').value.trim();
      if (!customName) {
        alert('請輸入檔案名稱！');
        return;
      }

      fetch(`/filemanager/edit/${filename}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': document.cookie
        },
        body: JSON.stringify({ customName, description })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('檔案資訊已更新！');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editFileModal'));
            modal.hide();
            loadFiles();
          } else {
            alert(data.error || '更新檔案資訊失敗');
          }
        })
        .catch(err => {
          console.error('更新檔案資訊錯誤:', err);
          alert('更新檔案資訊失敗: ' + err.message);
        });
    }

    // 上傳檔案
    document.getElementById('fileUploadForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const fileInput = document.getElementById('fileInput');
      const customName = document.getElementById('customName').value.trim();
      const description = document.getElementById('description').value.trim();
      const file = fileInput.files[0];
      if (!file) {
        alert('請選擇一個檔案！');
        return;
      }
      if (!customName) {
        alert('請輸入檔案名稱！');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('customName', customName);
      formData.append('description', description);

      fetch('/filemanager/upload', {
        method: 'POST',
        body: formData,
        headers: { 'Cookie': document.cookie }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('檔案上傳成功！');
            fileInput.value = '';
            document.getElementById('customName').value = '';
            document.getElementById('description').value = '';
            loadFiles();
          } else {
            alert(data.error || '檔案上傳失敗');
          }
        })
        .catch(err => {
          console.error('檔案上傳錯誤:', err);
          alert('檔案上傳失敗: ' + err.message);
        });
    });

    // 刪除檔案（已修正）
    function deleteFile(filename) {
      if (!confirm(`確定要刪除檔案 "${filename}" 嗎？`)) {
        return;
      }

      // 防護：防止傳入 userId 等非字串
      if (typeof filename !== 'string' || !filename.trim()) {
        alert('檔案名稱無效');
        return;
      }

      fetch(`/filemanager/delete/${encodeURIComponent(filename)}`, {
        method: 'DELETE',
        headers: { 'Cookie': document.cookie }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('檔案已刪除！');
            loadFiles();
          } else {
            alert(data.error || '刪除檔案失敗');
          }
        })
        .catch(err => {
          console.error('刪除檔案錯誤:', err);
          alert('刪除檔案失敗: ' + err.message);
        });
    }

    // 頁面載入時執行
    document.addEventListener('DOMContentLoaded', function () {
      loadFiles();
    });
  </script>
</body>
</html>